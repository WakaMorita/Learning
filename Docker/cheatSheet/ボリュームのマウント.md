## Dockerのボリュームマウント手順

### 概要
このガイドでは、Dockerコンテナでデータを永続化するための2つの方法について説明します：
1. バインドマウント：ホストマシンの特定のディレクトリをコンテナにマウント
2. Dockerボリューム：Docker管理下の永続化ストレージをコンテナにマウント

### バインドマウントとDockerボリュームの違い

#### 1. 管理方法
- **バインドマウント**
  - ホストのファイルシステムで直接管理
  - ホストの任意のディレクトリを指定可能
  - ホストOSに依存する

- **Dockerボリューム**
  - Dockerエンジンが管理
  - ホストのファイルシステムから独立
  - プラットフォーム非依存

#### 2. 使用に適したケース
- **バインドマウント**
  - 設定ファイルの共有
  - ソースコードのマウント（開発環境）
  - ホストと共有が必要なファイル

- **Dockerボリューム**
  - データベースの永続化
  - アプリケーションデータの保存
  - コンテナ間でのデータ共有

#### 3. 特徴の比較
| 観点 | バインドマウント | Dockerボリューム |
|------|----------------|-----------------|
| 場所の指定 | ホストの絶対パスが必要 | ボリューム名のみ |
| 初期内容 | ホスト側の既存ディレクトリ内容 | 空または指定したコンテナの内容 |
| バックアップ | 通常のファイルシステムツール | `docker volume`コマンド |
| 移植性 | 低い（ホストに依存） | 高い（Docker管理） |
| アクセス制御 | ホストOSの権限に依存 | Dockerで一元管理 |

### 重要な注意事項
1. データの永続化は以下の場合に重要です：
   - データベースファイル
   - 設定ファイル
   - アプリケーションデータ
   - ログファイル
2. 本番環境では適切なバックアップ戦略が必要
3. 権限設定に注意が必要

### 1. バインドマウント

#### 基本的な使用方法
```bash
docker run -v <ホストのパス>:<コンテナ内のパス> <イメージ名>
```

#### 実践例：Apache HTTPDでの検証

##### コンテナ設定
- コンテナ名: `apa000ex20`
- イメージ名: `httpd`
- ポート設定: `8090`（ホスト） → `80`（コンテナ）

##### マウント設定
- ホスト側パス: `C:\Users\{ユーザー名}\Documents\apa_folder`
- コンテナ内パス: `/usr/local/apache2/htdocs`

```bash
docker run --name apa000ex20 -d -p 8090:80 -v C:\Users\{ユーザー名}\Documents\apa_folder:/usr/local/apache2/htdocs httpd
```

<details>
<summary>📝 コマンドのパラメータ説明</summary>

- `--name`: コンテナ名を指定
- `-d`: デタッチモードで実行（バックグラウンド実行）
- `-p`: ポートマッピング（ホスト:コンテナ）
- `-v`: ボリュームマウントの設定
- `httpd`: Apache HTTPDのDockerイメージ
</details>

### 2. Dockerボリューム

#### ボリュームの作成
```bash
# ボリュームの作成
docker volume create my_volume

# ボリュームの一覧表示
docker volume ls

# ボリュームの詳細情報表示
docker volume inspect my_volume
```

#### ボリュームのマウント
```bash
docker run -v my_volume:/コンテナ内のパス イメージ名
```

#### 実践例：Apache HTTPDでの利用

##### コンテナ設定
- コンテナ名: `apa000ex21`
- イメージ名: `httpd`
- ボリューム名: `apa000vol1`
- ポート設定: `8091`（ホスト） → `80`（コンテナ）

##### マウント設定
- ボリューム: `apa000vol1`
- コンテナ内パス: `/usr/local/apache2/htdocs`

```bash
# Apache用のボリューム作成
docker volume create apa000vol1

# ボリュームを使用してApacheコンテナを起動
docker run --name apa000ex21 -d \
  -p 8091:80 \
  -v apa000vol1:/usr/local/apache2/htdocs \
  httpd

# ボリュームの確認
docker volume inspect apa000vol1
```

<details>
<summary>📝 コマンドのパラメータ説明</summary>

- `--name`: コンテナ名を指定
- `-d`: デタッチモードで実行（バックグラウンド実行）
- `-p`: ポートマッピング（ホスト:コンテナ）
- `-v`: ボリュームマウントの設定（データの永続化）
- `httpd`: Apache HTTPDのDockerイメージ
</details>

##### 動作確認
```bash
# コンテナの状態確認
docker ps

# コンテナ内のドキュメントルートにテストファイルを作成
docker exec apa000ex21 sh -c 'echo "<h1>Hello from Docker Volume</h1>" > /usr/local/apache2/htdocs/index.html'

# ブラウザでアクセス
start http://localhost:8091
```

### トラブルシューティング

<details>
<summary>🔍 よくあるエラーと解決方法</summary>

1. パーミッションエラー
   - SELinuxの設定確認（Linux環境の場合）
   - `:z`または`:Z`オプションの追加
   - ユーザー権限の確認

2. パスの問題
   - Windowsでのパス区切り文字に注意（`\`vs`/`）
   - 絶対パスの使用を推奨
   - パスに空白が含まれる場合はクォートで囲む

3. マウントポイントの競合
   - 既存のマウントポイントの確認
   - コンテナの再起動
</details>

### セキュリティに関する推奨事項
1. アクセス制御
   - 適切なファイル権限の設定
   - 最小権限の原則に従う
   - 機密データの扱いに注意

2. 本番環境での注意点
   - バックアップ戦略の策定
   - 定期的な権限監査
   - ボリュームの暗号化検討

### ベストプラクティス
1. **明確なボリューム戦略**
   - 用途に応じた適切な方式の選択
   - 命名規則の統一
   - ドキュメント化

2. **効率的な管理**
   - 未使用ボリュームの定期的なクリーンアップ
   - 監視とアラートの設定
   - 容量管理

3. **バックアップと復元**
   - 定期的なバックアップ
   - リストア手順の文書化
   - 定期的な復元テスト

### ボリューム管理コマンド
```bash
# ボリュームの作成
docker volume create <ボリューム名>

# ボリュームの一覧表示
docker volume ls

# ボリュームの詳細情報表示（マウントポイントなど）
docker volume inspect <ボリューム名>

# ボリュームの削除
docker volume rm <ボリューム名>

# 未使用ボリュームの一括削除
docker volume prune
```

参考文献：Docker&Kubernetesのきほんのきほん